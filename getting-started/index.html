<!DOCTYPE html>

<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="alternate" href="/index.xml" type="application/rss+xml" title="Koyomi">
		<link rel="icon" href="https://progrhy.me/App-Koyomi-Doc/favicon.ico">
		<title>Getting Started - Koyomi</title>
		
		<link rel="stylesheet" href="https://progrhy.me/App-Koyomi-Doc/css/highlight/magula.css">
		<link rel="stylesheet" href="https://progrhy.me/App-Koyomi-Doc/css/bootstrap.min.css">
		<link rel="stylesheet" href="https://progrhy.me/App-Koyomi-Doc/css/bootstrap-theme.min.css">
		<link rel="stylesheet" href="https://progrhy.me/App-Koyomi-Doc/css/theme.css">
		<link rel="stylesheet" href="https://progrhy.me/App-Koyomi-Doc/css/bootie-docs.css">
		<link rel="stylesheet" href="https://progrhy.me/App-Koyomi-Doc/css/site.css">
	</head>

<body role="document">

	
	<nav class="navbar navbar-inverse navbar-fixed-top">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="https://progrhy.me/App-Koyomi-Doc/">Koyomi</a>
			</div>
			<div id="navbar" class="navbar-collapse collapse">
				<ul class="nav navbar-nav">
					<li ><a href="https://progrhy.me/App-Koyomi-Doc/">Home</a></li>
			
			
				
					<li ><a href="/App-Koyomi-Doc/about/">About</a></li>
				
					<li class="active"><a href="/App-Koyomi-Doc/getting-started/">Quickstart</a></li>
				
			
				
				</ul>
				
				<form class="navbar-form navbar-left" role="search" action="https://www.google.co.jp/search" method="get">
					<div class="input-group doc-search-form">
						<input type="hidden" name="as_sitesearch" value="progrhyme.github.io/App-Koyomi-Doc">
						<input type="text" name="as_q" class="search-query doc-search-input-text" placeholder="Search Site">
						<span class="input-group-addon input-group-btn doc-search-input-btn">
							<button class="btn" type="submit"><span class="glyphicon glyphicon-search"></span></button>
						</span>
					</div>
				</form>
				
			</div>
		</div>
	</nav>

<div class="container">


<div class="row">
	<div class="col-sm-8 doc-main">
		<main role="main">
			<article>
				<a id="title"></a>
				<h1 class="doc-entry-title">Getting Started</h1>
				<div class="doc-entry-meta">
					<span><time datetime="2017-07-16">July 16, 2017</time></span>
				</div>
				<section>
					

<h2 id="install">Install</h2>

<p>Currently <strong>Koyomi</strong> is available on GitHub and CPAN.</p>

<p><em>Koyomi</em> depends on some external modules. And all its dependencies are written in <code>cpanfile</code>.</p>

<h3 id="from-github">From GitHub</h3>

<p>You can download archive files from <a href="https://github.com/progrhyme/perl5-App-Koyomi/releases">https://github.com/progrhyme/perl5-App-Koyomi/releases</a> .</p>

<pre><code>wget https://github.com/progrhyme/perl5-App-Koyomi/archive/vX.Y.Z.tar.gz
tar xvzf perl5-App-Koyomi-vX.Y.Z.tar.gz
cd perl5-App-Koyomi-vX.Y.Z
</code></pre>

<p>If you need to install dependent modules of <em>Koyomi</em>, install them by <code>cpanfile</code>.</p>

<pre><code>cpanm --installdeps .
</code></pre>

<p>Or you can use <a href="http://search.cpan.org/dist/carton/">carton</a> to install modules under <code>local/</code> directory.</p>

<pre><code>carton install
</code></pre>

<h3 id="from-cpan">From CPAN</h3>

<pre><code>cpanm App::Koyomi
</code></pre>

<p>This installs all dependent modules of <em>Koyomi</em> into your current perl.</p>

<p><a href="#">top</a></p>

<h2 id="configure">Configure</h2>

<p>The default configuration file is <code>config/default.toml</code>.<br />
You can edit the file for customization.
Or when you want to use the configuration file in another path, you can specify
the path by environmental variable <code>$KOYOMI_CONFIG_PATH</code>.</p>

<p>The following content shows available configuration parametes in the file.</p>

<h3 id="general-parameters">General Parameters</h3>

<pre><code>time_zone = &quot;Asia/Tokyo&quot; # Local time zone is used when not specified

# Enable some debug parameters (see &quot;Debug Parameters&quot; below)
# Don't set &quot;true&quot; on production environment.
debug_mode = true
</code></pre>

<h3 id="logging-parameters">Logging Parameters</h3>

<pre><code>[log]
debug   = true            # Enable debug log
console = true            # Output to stderr
file    = true            # Output to log file
file_path = /path/to/log  # Log file path
</code></pre>

<h3 id="job-scheduling-parameters">Job Scheduling Parameters</h3>

<pre><code>[worker]
interval_minutes = 1 # Worker interval

# Must be shorter than interval_minutes
minimum_interval_seconds = 30

[schedule]
update_interval_seconds = 120 # How often it re-fetch schedule from Datastore

[job]
# Must be shorter than worker.minimum_interval_seconds
lock_ttl_seconds = 25
</code></pre>

<p>When <code>worker.interval_minutes = 1</code>, <em>koyomi worker</em> wakes up and execute scheduled jobs at that time once a minute like <strong>cron</strong> daemon.
You can customize the parameter for longer intervals.</p>

<p><em>Koyomi worker</em> tries to wake up when the second of time equals <code>00</code> (ex: <code>T09:03:00</code>).
But it sleeps at least <code>worker.minimum_interval_seconds</code> every after spawning jobs once a <code>worker.interval_minutes</code>.</p>

<p>So if you start <em>koyomi worker</em> at <code>T09:02:55</code> and given <code>worker.minimum_interval_seconds = 30</code>, next time <em>wokrer</em> wakes up at <code>T09:03:25</code>, after that <code>T09:04:00</code>, then <code>T09:05:00</code>, &hellip;.</p>

<p><em>Koyomi worker</em> fetches jobs schedule from <strong>Datastore</strong> on start-up, and refetch it every after <code>schedule.update_interval_seconds</code>.</p>

<p>Multiple <em>koyomi workers</em> are supposed to run with the same schedule <em>datastore</em>.<br />
Only one <em>koyomi worker</em> runs a certain job at a time.</p>

<p>When a <em>koyomi worker</em> wins to run a job, it records on <em>datastore</em> the &ldquo;time&rdquo; and the &ldquo;hostname&rdquo; and the &ldquo;process id&rdquo;.<br />
On the other hand, another <em>koyomi worker</em> tries to run the job around the time.<br />
But with the job record in <em>datastore</em>, it knows the other <em>worker</em> has run it.<br />
When one <em>worker</em> has run a job within <code>job.lock_ttl_seconds</code>, the other <em>workers</em> quit to run the job.</p>

<h3 id="data-source-parameters">Data Source Parameters</h3>

<pre><code>[datasource.module]
job       = &quot;Teng&quot;
semaphore = &quot;Teng&quot;
#semaphore = &quot;None&quot;

[datasource.connector]
dsn      = &quot;dbi:mysql:database=koyomi;host=127.0.0.1;port=3306&quot;
#dsn      = &quot;dbi:SQLite:koyomi.sqlite&quot;
user     = &quot;root&quot;
password = &quot;&quot;

# Can override for each entity
[datasource.connector.job]
dsn  = ...
user = &quot;foo&quot;
password = &quot;xxx&quot;

[datasource.connector.semaphore]
# Can override &quot;datasource.connector&quot;, too.
</code></pre>

<p>Datasource <code>job</code> stands for job schedules.<br />
Datasource <code>semaphore</code> stands for the record and lock entity which controls if one <em>koyomi worker</em> can run a job or not.</p>

<p>You can specify perl module to access each entity of <em>datastore</em>.<br />
<code>Teng</code> modules are implemented for both &ldquo;job&rdquo; and &ldquo;semaphore&rdquo; datastore.</p>

<p><code>None</code> module which is only for &ldquo;semaphore&rdquo; satisfies the required interface of &ldquo;semaphore&rdquo; module, but actually does nothing about &ldquo;semaphore&rdquo;.<br />
<code>None</code> module is to be used when worker runs in a standalone mode while &ldquo;job&rdquo; is on local datastore like SQLite.
Because exclusive control for job execution is not required when there is only single worker.</p>

<h2 id="set-up-datastore">Set Up Datastore</h2>

<p>Here are descriptions about how to set up <em>datastore</em>.</p>

<h3 id="mysql">MySQL</h3>

<p>MySQL database schema is available at <code>schema/mysql/koyomi.ddl</code> in the source code repository.</p>

<h3 id="sqlite">SQLite</h3>

<p>SQLite database schema is also available at <code>schema/sqlite/koyomi.ddl</code> in the source code repository.</p>

<h3 id="job-registration">Job Registration</h3>

<p>You can register <code>jobs</code> by <strong>koyomi-cli</strong> (See below).<br />
Note that you have to prepare configuration file with right datasource settings beforehand.</p>

<h2 id="usage">Usage</h2>

<h3 id="worker">Worker</h3>

<p>You can launch <strong>koyomi worker</strong> in the way like this:</p>

<pre><code>koyomi -c /path/to/config.toml [--debug]
</code></pre>

<p>You can see details of command-line options by <code>koyomi --help</code>.</p>

<h3 id="cli">CLI</h3>

<p><code>koyomi-cli</code> is a handy command-line interface for CRUD of jobs.<br />
Run <code>koyomi-cli help</code> to see how to use this script.</p>

				</section>
			</article>
		</main>
	</div> 

	

<div class="col-sm-3 col-sm-offset-1 doc-sidebar">
	<div id="sidebar">
	<div class="sidebar-module">
		<div class="sidebar-toc">
			<h4 class="sidebar-heading">Table of Contents</h4>
			<ul>
				<li><strong><a href="#title">Getting Started</a></strong></li>
			</ul>
			<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#install">Install</a>
<ul>
<li><a href="#from-github">From GitHub</a></li>
<li><a href="#from-cpan">From CPAN</a></li>
</ul></li>
<li><a href="#configure">Configure</a>
<ul>
<li><a href="#general-parameters">General Parameters</a></li>
<li><a href="#logging-parameters">Logging Parameters</a></li>
<li><a href="#job-scheduling-parameters">Job Scheduling Parameters</a></li>
<li><a href="#data-source-parameters">Data Source Parameters</a></li>
</ul></li>
<li><a href="#set-up-datastore">Set Up Datastore</a>
<ul>
<li><a href="#mysql">MySQL</a></li>
<li><a href="#sqlite">SQLite</a></li>
<li><a href="#job-registration">Job Registration</a></li>
</ul></li>
<li><a href="#usage">Usage</a>
<ul>
<li><a href="#worker">Worker</a></li>
<li><a href="#cli">CLI</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
		</div>
	</div>
	<div class="sidebar-module">
		<h4 class="sidebar-heading">Pages in Categories</h4>
		<ul class="sidebar-category-list">
		
			<li>
				<a href="https://progrhy.me/App-Koyomi-Doc/categories/general">
					<span class="doc-list-category">General</span>
				</a>
				<ul>
					<li><a href="/App-Koyomi-Doc/about/">About</a>
					</li>
				
					<li>
						<span class="active">Getting Started</span>
						</li>
				
				</ul>
			</li>
		
		</ul>
	</div>
	<div class="sidebar-module">
		<h4 class="sidebar-heading">Tags</h4>
		<div class="tag-box">
		
			<a class="tag-item" href="https://progrhy.me/App-Koyomi-Doc/tags/document">document</a>
		
		</div>
	</div>
	</div>
</div>

</div> 


<hr />

<div class="row">
	<div class="col-sm-8">
		<p class="doc-footer-em"><a href="#" onclick="resetSidebarPos()">Back to TOP</a></p>
	</div>
</div>

</div> 

<footer class="doc-footer">
	<p class="doc-footer-em">Browse <strong><a href="https://github.com/progrhyme/perl5-App-Koyomi/">Repository</a></strong></p>
	<p>Copyright (c) 2015-2017, IKEDA Kiyoshi; All rights reserved.</p>
	<p>Powered by <strong><a href="https://github.com/progrhyme/hugo-theme-bootie-docs">Bootie Docs</a></strong> - theme for <a href="http://gohugo.io/">Hugo</a> by <a href="https://github.com/progrhyme/">progrhyme</a>.</p>
</footer>



<script src="https://progrhy.me/App-Koyomi-Doc/js/jquery.min.js"></script>
<script src="https://progrhy.me/App-Koyomi-Doc/js/bootstrap.min.js"></script>

<script src="https://progrhy.me/App-Koyomi-Doc/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script src="https://progrhy.me/App-Koyomi-Doc/js/ie10-viewport-bug-workaround.js"></script>
<script src="https://progrhy.me/App-Koyomi-Doc/js/bootie-docs.js"></script>

</body>
</html>
